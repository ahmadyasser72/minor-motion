---
import GridCardJadwal from "$lib/components/grid-card-jadwal.svelte";
import DefaultLayout from "$lib/layouts/default-layout.astro";
import type { ListStatusTugasMap, ListJadwalMap } from "$lib/types";
import { allHari } from "$lib/utils";
import { getMataKuliah } from "$lib/utils.content";

import { getCollection } from "astro:content";

const dailyJadwalMap = Object.fromEntries(
  allHari.map((hari) => [hari, []])
) as ListJadwalMap;

const allMataKuliah = await getMataKuliah();
for (const { data, id } of allMataKuliah) {
  dailyJadwalMap[data.hari].push({ ...data, id });
}

for (const [key, value] of Object.entries(dailyJadwalMap)) {
  if (value.length === 0) {
    delete dailyJadwalMap[key];
    continue;
  }

  dailyJadwalMap[key] = value.sort(
    ({ start: a }, { start: b }) => a.hour - b.hour || a.minute - b.minute
  );
}

const allStatusTugasMap: ListStatusTugasMap = Object.fromEntries(
  allMataKuliah.map(({ id }) => [id, []])
);

const allTugas = await getCollection("tugas");
for (const { data, slug } of allTugas) {
  const mataKuliah = data["mata-kuliah"].id;
  allStatusTugasMap[mataKuliah]?.push([
    slug,
    data["batas-waktu"] > new Date() ? "normal" : "lewat",
  ]);
}
---

<DefaultLayout title="Daftar Jadwal Harian" breadcrumbs={[{ label: "jadwal" }]}>
  <GridCardJadwal client:load {dailyJadwalMap} {allStatusTugasMap} />
</DefaultLayout>
